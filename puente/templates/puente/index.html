<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Control del Puente</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            padding: 30px;
        }

        .puente-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            border: 2px solid #e9ecef;
        }

        .puente-visual {
            background: linear-gradient(90deg, #8B4513 0%, #A0522D 50%, #8B4513 100%);
            height: 200px;
            border-radius: 10px;
            position: relative;
            margin: 20px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2em;
            font-weight: bold;
        }

        .auto-en-puente {
            background: #ff6b6b;
            color: white;
            padding: 10px 15px;
            border-radius: 20px;
            margin: 5px;
            display: inline-block;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .control-panel {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            border: 2px solid #e9ecef;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: transform 0.2s;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }

        .status-section {
            grid-column: 1 / -1;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            border: 2px solid #e9ecef;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .status-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .status-card h3 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .auto-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .auto-item {
            background: #f1f3f4;
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 5px;
            border-left: 3px solid #667eea;
        }

        .auto-item.en-puente {
            border-left-color: #e74c3c;
            background: #ffeaea;
        }

        .log-section {
            grid-column: 1 / -1;
            background: #2c3e50;
            color: white;
            border-radius: 10px;
            padding: 25px;
            max-height: 300px;
            overflow-y: auto;
        }

        .log-entry {
            padding: 8px 0;
            border-bottom: 1px solid #34495e;
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .timestamp {
            color: #95a5a6;
            font-size: 0.9em;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üåâ Sistema de Control del Puente</h1>
            <p>Sistema Distribuido - Gesti√≥n de Tr√°fico en Puente de Una V√≠a</p>
        </div>

        <div class="main-content">
            <div class="puente-section">
                <h2>üåâ Estado del Puente</h2>
                <div class="puente-visual" id="puenteVisual">
                    <div id="puenteStatus">Puente Libre</div>
                </div>
                <div id="autosEnPuente"></div>
            </div>

            <div class="control-panel">
                <h2>üöó Control de Autos</h2>
                <div class="form-group">
                    <label for="nombreAuto">Nombre del Auto:</label>
                    <input type="text" id="nombreAuto" placeholder="Ej: Auto_1234">
                </div>
                <div class="form-group">
                    <label for="velocidadAuto">Velocidad (km/h):</label>
                    <input type="number" id="velocidadAuto" min="30" max="120" value="60">
                </div>
                <div class="form-group">
                    <label for="tiempoEspera">Tiempo de Espera (seg):</label>
                    <input type="number" id="tiempoEspera" min="5" max="30" value="10">
                </div>
                <div class="form-group">
                    <label for="direccionAuto">Direcci√≥n:</label>
                    <select id="direccionAuto">
                        <option value="N">Norte a Sur</option>
                        <option value="S">Sur a Norte</option>
                    </select>
                </div>
                <button class="btn" onclick="registrarAuto()">Registrar Auto</button>
                <button class="btn btn-secondary" onclick="generarAutosAleatorios()">Generar Autos Aleatorios</button>
            </div>

            <div class="status-section">
                <h2>üìä Estado del Sistema</h2>
                <div class="status-grid">
                    <div class="status-card">
                        <h3>üöó Autos en el Puente</h3>
                        <div class="auto-list" id="autosEnPuenteList">
                            <p>Ning√∫n auto en el puente</p>
                        </div>
                    </div>
                    <div class="status-card">
                        <h3>‚è≥ Autos Esperando</h3>
                        <div class="auto-list" id="autosEsperandoList">
                            <p>Ning√∫n auto esperando</p>
                        </div>
                    </div>
                    <div class="status-card">
                        <h3>üìà Estad√≠sticas</h3>
                        <p><strong>Total de Autos:</strong> <span id="totalAutos">0</span></p>
                        <p><strong>Estado del Puente:</strong> <span id="estadoPuente">Libre</span></p>
                    </div>
                </div>
            </div>

            <div class="log-section">
                <h2>üìù Registro de Actividad</h2>
                <div id="logContainer"></div>
            </div>
        </div>
    </div>

    <script>
        let socket;
        let autosRegistrados = new Map();

        // Conectar WebSocket
        function conectarWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/puente/`;
            
            socket = new WebSocket(wsUrl);
            
            socket.onopen = function(e) {
                agregarLog('Conexi√≥n establecida con el servidor', 'info');
            };
            
            socket.onmessage = function(e) {
                const data = JSON.parse(e.data);
                manejarMensaje(data);
            };
            
            socket.onclose = function(e) {
                agregarLog('Conexi√≥n cerrada', 'error');
                // Reintentar conexi√≥n despu√©s de 5 segundos
                setTimeout(conectarWebSocket, 5000);
            };
            
            socket.onerror = function(e) {
                agregarLog('Error en la conexi√≥n WebSocket', 'error');
            };
        }

        // Manejar mensajes del servidor
        function manejarMensaje(data) {
            switch(data.type) {
                case 'estado_inicial':
                    actualizarEstadoInicial(data.data);
                    break;
                case 'auto_registrado':
                    autoRegistrado(data.auto);
                    break;
                case 'auto_cruzando':
                    autoCruzando(data.auto);
                    break;
                case 'auto_salio':
                    autoSalio(data.auto);
                    break;
                case 'respuesta_cruce':
                    manejarRespuestaCruce(data.data);
                    break;
                case 'error':
                    agregarLog(`Error: ${data.message}`, 'error');
                    break;
            }
        }

        // Actualizar estado inicial
        function actualizarEstadoInicial(estado) {
            actualizarListaAutos('autosEnPuenteList', estado.autos_en_puente);
            actualizarListaAutos('autosEsperandoList', estado.autos_esperando);
            document.getElementById('totalAutos').textContent = estado.total_autos;
            actualizarEstadoPuente();
        }

        // Registrar nuevo auto
        function registrarAuto() {
            const autoData = {
                nombre: document.getElementById('nombreAuto').value || `Auto_${Math.floor(Math.random() * 9000) + 1000}`,
                velocidad: parseFloat(document.getElementById('velocidadAuto').value),
                tiempo_espera: parseFloat(document.getElementById('tiempoEspera').value),
                direccion: document.getElementById('direccionAuto').value
            };

            socket.send(JSON.stringify({
                type: 'registrar_auto',
                auto: autoData
            }));

            // Limpiar formulario
            document.getElementById('nombreAuto').value = '';
        }

        // Auto registrado
        function autoRegistrado(auto) {
            autosRegistrados.set(auto.id, auto);
            agregarLog(`Auto ${auto.nombre} registrado (${auto.direccion === 'N' ? 'Norte a Sur' : 'Sur a Norte'})`, 'info');
            actualizarEstadisticas();
            
            // Iniciar simulaci√≥n del auto
            iniciarSimulacionAuto(auto);
        }

        // Iniciar simulaci√≥n de auto
        function iniciarSimulacionAuto(auto) {
            const simularCruce = async () => {
                // Solicitar permiso para cruzar
                socket.send(JSON.stringify({
                    type: 'solicitar_cruce',
                    auto_id: auto.id
                }));
            };

            // Simular cruces repetidos
            const simularCiclo = () => {
                simularCruce();
                // Esperar tiempo aleatorio antes del siguiente cruce
                setTimeout(simularCiclo, (auto.tiempo_espera + Math.random() * 10) * 1000);
            };

            // Iniciar despu√©s de un delay inicial
            setTimeout(simularCiclo, Math.random() * 5000);
        }

        // Manejar respuesta de cruce
        function manejarRespuestaCruce(respuesta) {
            if (respuesta.permiso) {
                agregarLog(`‚úÖ ${respuesta.mensaje}`, 'success');
            } else {
                agregarLog(`‚è≥ ${respuesta.mensaje}`, 'warning');
            }
        }

        // Auto cruzando
        function autoCruzando(auto) {
            agregarLog(`üöó ${auto.nombre} est√° cruzando el puente`, 'info');
            actualizarEstadoPuente();
            
            // Simular tiempo de cruce basado en velocidad
            const tiempoCruce = (1000 / auto.velocidad) * 1000; // 1km a la velocidad del auto
            setTimeout(() => {
                socket.send(JSON.stringify({
                    type: 'finalizar_cruce',
                    auto_id: auto.id
                }));
            }, tiempoCruce);
        }

        // Auto sali√≥ del puente
        function autoSalio(auto) {
            agregarLog(`‚úÖ ${auto.nombre} ha salido del puente`, 'success');
            actualizarEstadoPuente();
        }

        // Generar autos aleatorios
        function generarAutosAleatorios() {
            const cantidad = Math.floor(Math.random() * 5) + 3; // 3-7 autos
            agregarLog(`Generando ${cantidad} autos aleatorios...`, 'info');
            
            for (let i = 0; i < cantidad; i++) {
                setTimeout(() => {
                    const autoData = {
                        nombre: `Auto_${Math.floor(Math.random() * 9000) + 1000}`,
                        velocidad: Math.random() * 50 + 30, // 30-80 km/h
                        tiempo_espera: Math.random() * 15 + 5, // 5-20 segundos
                        direccion: Math.random() > 0.5 ? 'N' : 'S'
                    };
                    
                    socket.send(JSON.stringify({
                        type: 'registrar_auto',
                        auto: autoData
                    }));
                }, i * 1000); // Espaciar registros por 1 segundo
            }
        }

        // Actualizar estado del puente
        function actualizarEstadoPuente() {
            fetch('/api/estado-puente/')
                .then(response => response.json())
                .then(data => {
                    actualizarListaAutos('autosEnPuenteList', data.autos_en_puente);
                    actualizarListaAutos('autosEsperandoList', data.autos_esperando);
                    document.getElementById('totalAutos').textContent = data.total_autos;
                    
                    const puenteStatus = document.getElementById('puenteStatus');
                    const puenteVisual = document.getElementById('puenteVisual');
                    
                    if (data.autos_en_puente.length > 0) {
                        puenteStatus.textContent = `Puente Ocupado - ${data.autos_en_puente[0].nombre}`;
                        puenteVisual.style.background = 'linear-gradient(90deg, #e74c3c 0%, #c0392b 50%, #e74c3c 100%)';
                        document.getElementById('estadoPuente').textContent = 'Ocupado';
                    } else {
                        puenteStatus.textContent = 'Puente Libre';
                        puenteVisual.style.background = 'linear-gradient(90deg, #27ae60 0%, #2ecc71 50%, #27ae60 100%)';
                        document.getElementById('estadoPuente').textContent = 'Libre';
                    }
                });
        }

        // Actualizar lista de autos
        function actualizarListaAutos(elementId, autos) {
            const container = document.getElementById(elementId);
            if (autos.length === 0) {
                container.innerHTML = '<p>Ning√∫n auto</p>';
                return;
            }
            
            container.innerHTML = autos.map(auto => 
                `<div class="auto-item ${auto.en_puente ? 'en-puente' : ''}">
                    <strong>${auto.nombre}</strong><br>
                    ${auto.direccion === 'N' ? 'Norte a Sur' : 'Sur a Norte'} - ${auto.velocidad} km/h
                </div>`
            ).join('');
        }

        // Actualizar estad√≠sticas
        function actualizarEstadisticas() {
            document.getElementById('totalAutos').textContent = autosRegistrados.size;
        }

        // Agregar entrada al log
        function agregarLog(mensaje, tipo = 'info') {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            
            let icon = '‚ÑπÔ∏è';
            if (tipo === 'error') icon = '‚ùå';
            else if (tipo === 'success') icon = '‚úÖ';
            else if (tipo === 'warning') icon = '‚ö†Ô∏è';
            
            logEntry.innerHTML = `
                <span class="timestamp">${timestamp}</span>
                ${icon} ${mensaje}
            `;
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // Inicializar cuando se carga la p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            conectarWebSocket();
            agregarLog('Sistema de control del puente iniciado', 'info');
        });
    </script>
</body>
</html> 